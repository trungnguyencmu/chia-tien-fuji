import{r as n,g as N,a as B,f as L,j as e,L as I,d as z,b as W,c as F}from"./index-Bn_JVK_c.js";function k({onSubmit:c}){const[a,m]=n.useState([]),[l,d]=n.useState(""),[r,t]=n.useState(""),[i,s]=n.useState(!1),[h,f]=n.useState(""),[x,v]=n.useState(""),[g,u]=n.useState(""),[p,S]=n.useState(new Date().toISOString().split("T")[0]),[y,C]=n.useState(!1),[A,E]=n.useState(null);n.useEffect(()=>{N()&&P()},[]);const P=async()=>{if(!N())return;const o=B().filter(b=>typeof b=="string");m(o);try{const j=(await L()).filter(w=>typeof w=="string");m(j)}catch(b){console.error("Failed to fetch payer names:",b)}},D=o=>{d(o),o==="custom"?s(!0):(s(!1),t(""))},T=o=>{const j=o.target.value.replace(/\D/g,"");if(v(j),j){const w=Number(j).toLocaleString("en-US");u(w)}else u("")},M=async o=>{o.preventDefault(),E(null);const b=l==="custom"?r:l;if(!b||!h||!x||!p){E("All fields are required");return}const j=parseFloat(x);if(isNaN(j)||j<=0){E("Amount must be a positive number");return}C(!0);try{await c({payer:b,title:h,amount:j,date:p}),d(""),t(""),s(!1),f(""),v(""),u(""),S(new Date().toISOString().split("T")[0])}catch(w){E(w instanceof Error?w.message:"Failed to add expense")}finally{C(!1)}};return e.jsxs("div",{className:"card",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1.5rem"},children:[e.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"700",margin:0},children:"üí∏ Add New Expense"}),a.length===0&&e.jsx(I,{to:"/admin",className:"btn btn-secondary",style:{textDecoration:"none",fontSize:"0.875rem"},children:"‚öôÔ∏è Add Payers"})]}),e.jsxs("form",{onSubmit:M,children:[e.jsxs("div",{className:"grid grid-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"payer",children:"Payer Name"}),a.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("select",{id:"payer",className:"form-input",value:l,onChange:o=>D(o.target.value),disabled:y,style:{cursor:"pointer"},children:[e.jsx("option",{value:"",children:"Select a payer..."}),a.map(o=>e.jsx("option",{value:o,children:o},o)),e.jsx("option",{value:"custom",children:"‚ûï Other (enter name)"})]}),i&&e.jsx("input",{type:"text",className:"form-input",value:r,onChange:o=>t(o.target.value),disabled:y,placeholder:"Enter custom name",style:{marginTop:"0.5rem"}})]}):e.jsx("input",{id:"payer",type:"text",className:"form-input",value:l,onChange:o=>d(o.target.value),disabled:y,placeholder:"Enter name (or add payers in admin)"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"title",children:"Title"}),e.jsx("input",{id:"title",type:"text",className:"form-input",value:h,onChange:o=>f(o.target.value),disabled:y,placeholder:"e.g., Dinner, Hotel"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"amount",children:"Amount (VND)"}),e.jsx("input",{id:"amount",type:"text",inputMode:"numeric",className:"form-input",value:g,onChange:T,disabled:y,placeholder:"0"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"date",children:"Date"}),e.jsx("input",{id:"date",type:"date",className:"form-input",value:p,onChange:o=>S(o.target.value),disabled:y})]})]}),e.jsx("button",{type:"submit",disabled:y,className:"btn btn-primary",children:y?"‚è≥ Adding...":"‚ûï Add Expense"}),A&&e.jsxs("div",{className:"alert alert-error",style:{marginTop:"1rem"},children:["‚ö†Ô∏è ",A]})]})]})}const O=n.memo(function({expenses:a,onExpenseDeleted:m}){const[l,d]=n.useState(null),r=n.useCallback(async(s,h)=>{const f=N();if(!f){alert("No trip selected");return}const x=window.prompt(`‚ö†Ô∏è Delete "${h}"?

Enter password to confirm:`);if(x){d(s);try{await z(f,s,x),m()}catch(v){alert(v instanceof Error?v.message:"Failed to delete expense")}finally{d(null)}}},[m]),t=n.useMemo(()=>[...a].sort((s,h)=>new Date(h.createdAt).getTime()-new Date(s.createdAt).getTime()),[a]),i=n.useMemo(()=>a.reduce((s,h)=>s+h.amount,0),[a]);return a.length===0?e.jsxs("div",{className:"card",children:[e.jsx("h2",{style:{marginBottom:"1rem",fontSize:"1.5rem",fontWeight:"700"},children:"üìã Expenses"}),e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:"üí≥"}),e.jsx("p",{children:"No expenses yet. Add one above!"})]})]}):e.jsxs("div",{className:"card",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1.5rem"},children:[e.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"700",margin:0},children:"üìã Expenses"}),e.jsxs("div",{className:"badge badge-neutral",children:[a.length," ",a.length===1?"expense":"expenses"]})]}),e.jsxs("div",{className:"stat-card",style:{marginBottom:"1.5rem"},children:[e.jsx("div",{className:"stat-label",children:"Total Expenses"}),e.jsxs("div",{className:"stat-value",children:[i.toLocaleString()," VND"]})]}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Payer"}),e.jsx("th",{children:"Title"}),e.jsx("th",{className:"text-right",children:"Amount (VND)"}),e.jsx("th",{style:{width:"100px"},children:"Action"})]})}),e.jsx("tbody",{children:t.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.date}),e.jsx("td",{children:e.jsx("strong",{children:s.payer})}),e.jsx("td",{children:s.title}),e.jsx("td",{className:"text-right",style:{fontWeight:"600"},children:s.amount.toLocaleString()}),e.jsx("td",{children:e.jsx("button",{onClick:()=>r(s.id,s.title),disabled:l===s.id,style:{padding:"0.375rem 0.75rem",background:"#fee2e2",color:"#991b1b",borderRadius:"6px",border:"none",fontWeight:"600",fontSize:"0.75rem",cursor:l===s.id?"not-allowed":"pointer",transition:"all 0.2s",opacity:l===s.id?.6:1},onMouseOver:h=>{l!==s.id&&(h.currentTarget.style.background="#fecaca")},onMouseOut:h=>{l!==s.id&&(h.currentTarget.style.background="#fee2e2")},children:l===s.id?"‚è≥":"üóëÔ∏è"})})]},s.id))})]})})]})});function V(c,a){if(c.length===0&&(!a||a.length===0))return[];const m=c.reduce((t,i)=>t+i.amount,0),l=new Map;c.forEach(t=>{const i=l.get(t.payer)||0;l.set(t.payer,i+t.amount)});let d;if(a&&a.length>0?d=a:d=Array.from(l.keys()),d.length===0)return[];const r=m/d.length;return d.map(t=>{const i=l.get(t)||0,s=i-r;return{member:t,totalPaid:i,share:r,balance:s}})}function R(c){const a=[],m=c.filter(t=>t.balance<-.01).map(t=>({member:t.member,amount:-t.balance})).sort((t,i)=>i.amount-t.amount),l=c.filter(t=>t.balance>.01).map(t=>({member:t.member,amount:t.balance})).sort((t,i)=>i.amount-t.amount);let d=0,r=0;for(;d<m.length&&r<l.length;){const t=m[d],i=l[r],s=Math.min(t.amount,i.amount);a.push({from:t.member,to:i.member,amount:Math.round(s)}),t.amount-=s,i.amount-=s,t.amount<.01&&d++,i.amount<.01&&r++}return a}function $(c){return`${c.from} owes ${c.to} ${c.amount.toLocaleString()} VND`}function H({expenses:c,payerNames:a}){const m=n.useMemo(()=>V(c,a),[c,a]),l=n.useMemo(()=>R(m),[m]),d=n.useMemo(()=>c.reduce((r,t)=>r+t.amount,0),[c]);return c.length===0?null:e.jsxs("div",{className:"card",children:[e.jsx("h2",{style:{marginBottom:"1.5rem",fontSize:"1.5rem",fontWeight:"700"},children:"üí∞ Settlement"}),e.jsxs("div",{style:{marginBottom:"2rem"},children:[e.jsx("h3",{style:{fontSize:"1.125rem",fontWeight:"600",marginBottom:"1rem"},children:"Summary"}),e.jsxs("div",{className:"grid grid-2",style:{gap:"1rem"},children:[e.jsxs("div",{className:"stat-card",style:{borderLeftColor:"#4f46e5"},children:[e.jsx("div",{className:"stat-label",children:"Total Expenses"}),e.jsxs("div",{className:"stat-value",children:[d.toLocaleString()," VND"]})]}),e.jsxs("div",{className:"stat-card",style:{borderLeftColor:"#10b981"},children:[e.jsx("div",{className:"stat-label",children:"Members"}),e.jsx("div",{className:"stat-value",children:m.length})]}),e.jsxs("div",{className:"stat-card",style:{borderLeftColor:"#f59e0b",gridColumn:"span 2"},children:[e.jsx("div",{className:"stat-label",children:"Share per Person"}),e.jsxs("div",{className:"stat-value",children:[Math.round(d/m.length).toLocaleString()," VND"]})]})]})]}),e.jsxs("div",{style:{marginBottom:"2rem"},children:[e.jsx("h3",{style:{fontSize:"1.125rem",fontWeight:"600",marginBottom:"1rem"},children:"Member Balances"}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Member"}),e.jsx("th",{className:"text-right",children:"Paid"}),e.jsx("th",{className:"text-right",children:"Share"}),e.jsx("th",{className:"text-right",children:"Balance"})]})}),e.jsx("tbody",{children:m.map(r=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:r.member})}),e.jsx("td",{className:"text-right",children:Math.round(r.totalPaid).toLocaleString()}),e.jsx("td",{className:"text-right",children:Math.round(r.share).toLocaleString()}),e.jsx("td",{className:"text-right",children:e.jsxs("span",{className:r.balance>.01?"badge badge-success":r.balance<-.01?"badge badge-danger":"badge badge-neutral",children:[r.balance>.01&&"+",Math.round(r.balance).toLocaleString()]})})]},r.member))})]})})]}),e.jsxs("div",{children:[e.jsx("h3",{style:{fontSize:"1.125rem",fontWeight:"600",marginBottom:"1rem"},children:"üîÑ Who Owes Whom"}),l.length===0?e.jsxs("div",{className:"empty-state",style:{padding:"2rem 1rem"},children:[e.jsx("div",{className:"empty-state-icon",children:"‚úÖ"}),e.jsx("p",{style:{fontSize:"1.125rem",fontWeight:"600",color:"#10b981"},children:"Everyone is settled!"})]}):e.jsx("ul",{className:"transaction-list",children:l.map((r,t)=>e.jsxs("li",{className:"transaction-item",children:["üí∏ ",$(r)]},t))})]})]})}function G(){const[c,a]=n.useState([]),[m,l]=n.useState([]),[d,r]=n.useState(!0),[t,i]=n.useState(null),[s,h]=n.useState(null);n.useEffect(()=>{const g=N();h(g),g?(x(),f()):r(!1);const u=()=>{N()&&(x(),f())},p=()=>{const S=N();h(S),S&&(x(),f())};return window.addEventListener("refreshExpenses",u),window.addEventListener("tripChanged",p),()=>{window.removeEventListener("refreshExpenses",u),window.removeEventListener("tripChanged",p)}},[]);const f=async()=>{try{const g=await L();l(g)}catch(g){console.error("Failed to load payer names:",g)}},x=async()=>{const g=N();if(!g){i("No trip selected"),r(!1);return}r(!0),i(null);try{const u=await W(g);a(u)}catch(u){i(u instanceof Error?u.message:"Failed to load expenses")}finally{r(!1)}},v=async g=>{const u=N();if(!u)throw new Error("No trip selected");const p=await F(u,g);a(S=>[...S,p])};return s?d?e.jsxs("div",{style:{textAlign:"center",padding:"3rem"},children:[e.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem"},children:"‚è≥"}),e.jsx("div",{style:{color:"white",fontSize:"1.25rem",fontWeight:"600"},children:"Loading expenses..."})]}):e.jsxs("div",{children:[t&&e.jsxs("div",{className:"alert alert-error",children:[e.jsx("span",{style:{fontSize:"1.5rem"},children:"‚ö†Ô∏è"}),e.jsxs("div",{style:{flex:1},children:[e.jsx("strong",{children:"Error:"})," ",t]}),e.jsx("button",{onClick:x,className:"btn btn-primary",children:"Retry"})]}),e.jsx(k,{onSubmit:v}),e.jsx(O,{expenses:c,onExpenseDeleted:x}),e.jsx(H,{expenses:c,payerNames:m})]}):e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx("div",{style:{fontSize:"4rem",marginBottom:"1rem"},children:"‚úàÔ∏è"}),e.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"700",marginBottom:"1rem",color:"var(--gray-900)"},children:"No Trip Selected"}),e.jsx("p",{style:{color:"var(--gray-600)",marginBottom:"2rem",fontSize:"1.1rem"},children:"Please create or select a trip in the Admin page to get started!"}),e.jsx("a",{href:"/admin",className:"btn btn-primary",style:{textDecoration:"none"},children:"‚öôÔ∏è Go to Admin"})]})}export{G as default};
